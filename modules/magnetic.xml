<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<module:module xmlns:module="XMLModule" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="XMLModule ../xsd/module_xml.xsd">
<module:field>

  <module:general_field id="magnetic" name="Magnetic field">
    <module:description>Magnetic field ...</module:description>
    <module:analyses>
      <module:analysis id="steadystate" name="Steady state" solutions="1" type="steadystate">
        <module:field_config>
          <field_item field_key="NonlinearDampingCoeff" field_value="0.8"/>
          <field_item field_key="NewtonAutomaticDampingCoeff" field_value="0.8"/>
        </module:field_config>
      </module:analysis>
    </module:analyses>
    </module:general_field>

  <module:constants>
      <module:constant id="MU0" value="1.2566371e-06"/>
      <module:constant id="SMALL" value="1e-5"/>
  </module:constants>

  <module:spaces>
    <module:space analysistype="steadystate">
      <module:space_config i="1" orderadjust="0" type="h1"/>
    </module:space>
  </module:spaces>

  <module:volume>
    <module:quantity id="magnetic_permeability" shortname="ma_mur"/>
    <module:quantity id="magnetic_conductivity" shortname="ma_gamma"/>
    <module:quantity id="magnetic_current_density_external_real" shortname="ma_Jer"/>
    <module:quantity id="magnetic_current_density_external_imag" shortname="ma_Jei"/>
    <module:quantity id="magnetic_total_current_prescribed" shortname="ma_IPrescribed"/>
    <module:quantity id="magnetic_total_current_real" shortname="ma_Itr"/>
    <module:quantity id="magnetic_total_current_imag" shortname="ma_Iti"/>

    <module:function id="magnetic_func_current_density_external_real_complete" shortname="ma_Jer_compl" type="constant" postprocessor_linearity="linear" postprocessor_analysis="steadystate">
      <module:quantity id="magnetic_current_density_external_real"/>
      <module:quantity id="magnetic_total_current_prescribed"/>
      <module:quantity id="magnetic_total_current_real"/>
      <!-- TODO: 1.0 -> area -->
      <module:function_variant expr="(1-ma_IPrescribed) * ma_Jer + ma_IPrescribed * ma_Itr / 1.0"/>
    </module:function>
    
    <module:function id="magnetic_func_one_over_mu" shortname="ma_one_over_mu" type="constant" >
      <module:quantity id="magnetic_permeability"/>
      <module:function_variant expr="1 / (ma_mur * MU0)"/>
    </module:function>

    <module:matrix_form id="steady_laplace" i="1" j="1" planar="ma_one_over_mu * (udx * vdx + udy * vdy)" symmetric_planar="1" axi="ma_one_over_mu * ((udr * vdr + udz * vdz) + uval * vdr / r) "/>
   
    <module:vector_form  id="steady_rhs_current" i="1" j="1" planar="ma_Jer_compl * vval " axi="ma_Jer_compl * vval" />

    <module:weakforms_volume>
      <module:weakform_volume analysistype="steadystate" equation="\curl \left( \frac{1}{\mu}\, \left( \curl \vec{A} - \vec{B}_\mathrm{r} \right) \right) - \gamma \vec{v} \times \curl \vec{A} = \vec{J}_\mathrm{ext}">
        <module:quantity id="magnetic_permeability" nonlinearity_axi="sqrt(dz1*dz1 + (dr1 + value1 / (r+1e-12))*(dr1 + value1 / (r+1e-12)))" nonlinearity_planar="sqrt(dx1*dx1 + dy1*dy1)"/>
        <module:quantity id="magnetic_conductivity"/>
        <module:quantity id="magnetic_current_density_external_real" dependence="time" />
        <module:quantity id="magnetic_total_current_prescribed" />
        <module:quantity id="magnetic_total_current_real" />

        <module:function_use id="magnetic_func_current_density_external_real_complete"/>
        <module:function_use id="magnetic_func_one_over_mu" nonlinearity_axi="sqrt(dz1*dz1 + (dr1 + value1 / r)*(dr1 + value1 / r))" nonlinearity_planar="sqrt(dx1*dx1 + dy1*dy1)"/>
        <module:function_use id="magnetic_func_one_over_norm_a_steady" nonlinearity_axi="sqrt(dz1*dz1 + (dr1 + value1 / r)*(dr1 + value1 / r))" nonlinearity_planar="sqrt(dx1*dx1 + dy1*dy1)"/>

        <module:linearity_option type="linear">
          <module:matrix_form id="steady_laplace"/>
          <module:vector_form id="steady_rhs_current"/>          
        </module:linearity_option>
      </module:weakform_volume>
    </module:weakforms_volume>
  </module:volume>

  <module:surface>
    <module:quantity id="magnetic_potential_real" shortname="Ar"/>
    <module:quantity id="magnetic_potential_imag" shortname="Ai"/>
    <module:quantity id="magnetic_surface_current_real" shortname="Jr"/>
    <module:quantity id="magnetic_surface_current_imag" shortname="Ji"/>

    <module:essential_form id="steady_essential" i="1" axi="Ar" planar="Ar"/>
    <module:vector_form id="steady_current" i="1" j="1" axi="-Jr * vval" planar="-Jr * vval"/>
    <module:weakforms_surface>
      <module:weakform_surface analysistype="steadystate" default="magnetic_potential">
        <module:boundary equation="A = A_0" id="magnetic_potential" name="Magnetic potential">
          <module:quantity dependence="space" id="magnetic_potential_real"/>

          <module:linearity_option type="linear">
            <module:essential_form id="steady_essential"/>
          </module:linearity_option>
        </module:boundary>

        <module:boundary equation="K = - \frac{1}{\mu} \frac{\partial A}{\partial n_0} = K_0" id="magnetic_surface_current" name="Surface current">
          <module:quantity id="magnetic_surface_current_real"/>

          <module:linearity_option type="linear">
            <module:vector_form id="steady_current"/>
          </module:linearity_option>
        </module:boundary>
      </module:weakform_surface>
    </module:weakforms_surface>
  </module:surface>

  <module:error_calculator>
  </module:error_calculator>

  <module:preprocessor>
    <module:gui type="volume">
      <module:group name="Material properties">
        <module:quantity condition="value > 0" default="1" id="magnetic_permeability" name="Permeability" shortname="mur" shortname_dependence="B" shortname_dependence_html="&lt;i>B&lt;/i>" shortname_html="&lt;i>&amp;mu;&lt;/i>&lt;sub>r&lt;/sub>" unit="-" unit_html="-" unit_latex="-"/>
        <module:quantity id="magnetic_conductivity" name="Electrical conductivity" shortname="gamma" shortname_html="&lt;i>&amp;gamma;&lt;/i>" unit="S/m" unit_html="S.m&lt;sup>-1&lt;/sup>" unit_latex="S \cdot m^{-1}"/>
      </module:group>
      <module:group name="Source">
        <module:quantity id="magnetic_current_density_external_real" name="Current dens. - ext. - real" is_source="1" only_if_not="magnetic_total_current_prescribed" shortname="Jer" shortname_html="&lt;i>J&lt;/i>&lt;sub>ext,r&lt;/sub>" unit="A/m2" unit_html="A.m&lt;sup>-2&lt;/sup>" unit_latex="A \cdot m^{-2}"/>
        <module:quantity id="magnetic_current_density_external_imag" name="Current dens. - ext. - imag" is_source="1" only_if_not="magnetic_total_current_prescribed" shortname="Jei" shortname_html="&lt;i>J&lt;/i>&lt;sub>ext,i&lt;/sub>" unit="A/m2" unit_html="A.m&lt;sup>-2&lt;/sup>" unit_latex="A \cdot m^{-2}"/>
        <module:quantity id="magnetic_total_current_prescribed" name="Total current prescribed" is_bool="1" shortname="IPrescribed" shortname_html="IPrescribed" unit="-" unit_html="-" unit_latex="-"/>
        <module:quantity id="magnetic_total_current_real" name="Total current - real" is_source="1" only_if="magnetic_total_current_prescribed" shortname="Itr" shortname_html="&lt;i>I&lt;/i>&lt;sub>t,r&lt;/sub>" unit="A" unit_html="A" unit_latex="A"/>
        <module:quantity id="magnetic_total_current_imag" name="Total current - imag" is_source="1" only_if="magnetic_total_current_prescribed" shortname="Iti" shortname_html="&lt;i>I&lt;/i>&lt;sub>t,i&lt;/sub>" unit="A" unit_html="A" unit_latex="A"/>
      </module:group>
    </module:gui>
    <module:gui type="surface">
      <module:group>
        <module:quantity condition="" default="0" id="magnetic_potential_real" name="Vector potential - real" shortname="Ar" shortname_html="&lt;i>A&lt;/i>&lt;sub>r&lt;/sub>" shortname_latex="" unit="Wb/m" unit_html="Wb.m&lt;sup>-1&lt;/sup>" unit_latex="Wb \cdot m^{-1}"/>
        <module:quantity condition="" default="0" id="magnetic_potential_imag" name="Vector potential - imag" shortname="Ai" shortname_html="&lt;i>A&lt;/i>&lt;sub>i&lt;/sub>" shortname_latex="" unit="Wb/m" unit_html="Wb.m&lt;sup>-1&lt;/sup>" unit_latex="Wb \cdot m^{-1}"/>
        <module:quantity condition="" default="0" id="magnetic_surface_current_real" name="Surface current - real" shortname="Jr" shortname_html="&lt;i>J&lt;/i>&lt;sub>r&lt;/sub>" shortname_latex="" unit="A/m" unit_html="A.m&lt;sup>-1&lt;/sup>" unit_latex="A \cdot m^{-1}"/>
        <module:quantity condition="" default="0" id="magnetic_surface_current_imag" name="Surface current - imag" shortname="Ji" shortname_html="&lt;i>J&lt;/i>&lt;sub>i&lt;/sub>" shortname_latex="" unit="A/m" unit_html="A.m&lt;sup>-1&lt;/sup>" unit_latex="A \cdot m^{-1}"/>
      </module:group>
    </module:gui>
  </module:preprocessor>

  <module:postprocessor>
    <module:localvariables>
     
    </module:localvariables>
    <module:view>
      <module:scalar_view>
        <module:default analysistype="steadystate" id="magnetic_flux_density_real"/>  
      </module:scalar_view>
      <module:vector_view>
        <module:default analysistype="steadystate" id="magnetic_flux_density_real"/>
      </module:vector_view>
    </module:view>
    <module:volumeintegrals>
      <module:volumeintegral id="magnetic_volume" name="Volume" shortname="V" shortname_html="&lt;i>V&lt;/i>" shortname_latex="V" unit="m3" unit_html="m&lt;sup>3&lt;/sup>" unit_latex="m^{3}">
        <module:expression analysistype="steadystate" axi="2.0 * PI * r" planar="1.0"/>
      </module:volumeintegral>
    </module:volumeintegrals>

    <module:surfaceintegrals>
      
    </module:surfaceintegrals>
    <module:force>
      <module:expression analysistype="steadystate" axi_phi="velz * dz1 + velr * (dr1 + tern(r > SMALL, value1/r, dr1))" axi_r="- velphi * (r * dr1 + value1)" axi_z="- velphi * r * (dz1)" planar_x="- velz * (-dx1)" planar_y="velz * dy1" planar_z="velx * (-dx1) - vely * dy1"/>
    </module:force>
  </module:postprocessor>

</module:field>
</module:module>
